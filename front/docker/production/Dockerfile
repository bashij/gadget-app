FROM node:lts-buster-slim

WORKDIR /usr/src/app

RUN touch .env.production

ARG NEXT_PUBLIC_IS_DEV
ARG NEXT_PUBLIC_API_ENDPOINT_USERS
ARG NEXT_PUBLIC_API_ENDPOINT_RELATIONSHIPS
ARG NEXT_PUBLIC_API_ENDPOINT_LOGIN
ARG NEXT_PUBLIC_API_ENDPOINT_LOGOUT
ARG NEXT_PUBLIC_API_ENDPOINT_TWEETS
ARG NEXT_PUBLIC_API_ENDPOINT_COMMUNITIES
ARG NEXT_PUBLIC_API_ENDPOINT_GADGETS
ARG NEXT_PUBLIC_API_ENDPOINT_GUEST
ARG API_ENDPOINT_CHECK_SESSION
ARG API_ENDPOINT_USERS
ARG API_ENDPOINT_COMMUNITIES
ARG API_ENDPOINT_GADGETS

RUN echo "NEXT_PUBLIC_IS_DEV=$NEXT_PUBLIC_IS_DEV" >> .env.production
RUN echo "NEXT_PUBLIC_API_ENDPOINT_USERS=$NEXT_PUBLIC_API_ENDPOINT_USERS" >> .env.production
RUN echo "NEXT_PUBLIC_API_ENDPOINT_RELATIONSHIPS=$NEXT_PUBLIC_API_ENDPOINT_RELATIONSHIPS" >> .env.production
RUN echo "NEXT_PUBLIC_API_ENDPOINT_LOGIN=$NEXT_PUBLIC_API_ENDPOINT_LOGIN" >> .env.production
RUN echo "NEXT_PUBLIC_API_ENDPOINT_LOGOUT=$NEXT_PUBLIC_API_ENDPOINT_LOGOUT" >> .env.production
RUN echo "NEXT_PUBLIC_API_ENDPOINT_TWEETS=$NEXT_PUBLIC_API_ENDPOINT_TWEETS" >> .env.production
RUN echo "NEXT_PUBLIC_API_ENDPOINT_COMMUNITIES=$NEXT_PUBLIC_API_ENDPOINT_COMMUNITIES" >> .env.production
RUN echo "NEXT_PUBLIC_API_ENDPOINT_GADGETS=$NEXT_PUBLIC_API_ENDPOINT_GADGETS" >> .env.production
RUN echo "NEXT_PUBLIC_API_ENDPOINT_GUEST=$NEXT_PUBLIC_API_ENDPOINT_GUEST" >> .env.production
RUN echo "API_ENDPOINT_CHECK_SESSION=$API_ENDPOINT_CHECK_SESSION" >> .env.production
RUN echo "API_ENDPOINT_USERS=$API_ENDPOINT_USERS" >> .env.production
RUN echo "API_ENDPOINT_COMMUNITIES=$API_ENDPOINT_COMMUNITIES" >> .env.production
RUN echo "API_ENDPOINT_GADGETS=$API_ENDPOINT_GADGETS" >> .env.production

COPY ../../app ./

RUN yarn install && \
    yarn build

EXPOSE 3000

CMD ["yarn", "start"]